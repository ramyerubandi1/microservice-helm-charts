pipeline {
    agent { label 'seh-sit' }  // Specify the correct node label

    environment {
        AWS_REGION = 'us-west-2'
        CLUSTER_NAME = 'my-cluster'
        BRANCH_NAME = 'main'
    }

    stages {
        stage('Checkout') {
            steps {
                git branch: "${env.BRANCH_NAME}", url: 'https://github.com/ramyerubandi1/microservice-helm-charts.git'
            }
        }

        stage('Configure AWS') {
            steps {
                script {
                    sh '''
                    #!/bin/bash
                    aws eks update-kubeconfig --region "${AWS_REGION}" --name "${CLUSTER_NAME}"
                    '''
                }
            }
        }

        stage('Deploy with Helm') {
            steps {
                script {
                    // Ensure variable substitution is done correctly
                    sh """
                    #!/bin/bash
                    helm upgrade --install my-release ./salary-app --namespace default 
                    """
                }
            }
        }
    }

    post {
        always {
            cleanWs()
        }
    }
}
